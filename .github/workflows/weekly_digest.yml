# Weekly digest: generate, publish and email (with OpenAI debug step)
name: Weekly digest (generate, publish, email)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      OPENAI_MODEL: gpt-3.5-turbo
      MAX_SUMMARIZED: '999999'
      PRIORITY_FILE: data/senders_priority.csv

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Debug: check Python & env & OpenAI connectivity
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ env.OPENAI_MODEL }}
        run: |
          python -V
          pip show openai || true
          # check presence of secret (do NOT print its value)
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "ERROR: OPENAI_API_KEY secret is NOT configured in repo secrets!"
            exit 1
          else
            echo "OPENAI_API_KEY secret appears configured."
          fi
          # Minimal OpenAI connectivity test (may consume tiny number of tokens)
          if [ -f src/openai_test.py ]; then
            python -u src/openai_test.py
          else
            echo "Warning: src/openai_test.py not found â€” skip runtime OpenAI connectivity check."
          fi

      - name: Run weekly digest
        env:
          IMAP_HOST: ${{ secrets.IMAP_HOST }}
          IMAP_USER: ${{ secrets.IMAP_USER }}
          IMAP_PASSWORD: ${{ secrets.IMAP_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ env.OPENAI_MODEL }}
          MAX_SUMMARIZED: ${{ env.MAX_SUMMARIZED }}
          PRIORITY_FILE: ${{ env.PRIORITY_FILE }}
        run: |
          python -u src/main.py

      - name: Upload artifact (data/)
        uses: actions/upload-artifact@v4
        with:
          name: weekly-digest-data
          path: data

      - name: Deploy to GitHub Pages (publish data/ as site)
        uses: peaceiris/actions-gh-pages@v4
        with:
          publish_dir: ./data
          publish_branch: gh-pages
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send digest by email (if SMTP secrets present)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_SENDER: ${{ secrets.SMTP_SENDER }}
          SMTP_RECIPIENTS: ${{ secrets.SMTP_RECIPIENTS }}
        run: |
          if python -c "import os,sys; print(bool(os.getenv('SMTP_HOST')))" | grep -q True; then
            python -u src/send_email.py
          else
            echo "SMTP credentials not configured; skipping email send."
          fi
